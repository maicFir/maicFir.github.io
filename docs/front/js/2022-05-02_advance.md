---
title: è§£å†³è·¨åŸŸçš„å‡ ç§æ–¹æ¡ˆ
date: 2022-05-01
sidebarDepth: 3
---

> è·¨åŸŸäº§ç”Ÿçš„åŸå› é¦–å…ˆæ˜¯å—æµè§ˆå™¨çš„å®‰å…¨æ€§è®¾è®¡å½±å“ï¼Œç”±äºæµè§ˆå™¨åŒæºç­–ç•¥çš„è®¾è®¡ï¼Œæ‰€ä»¥äº§ç”Ÿäº†è·¨åŸŸã€‚

åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸é‡åˆ°è·¨åŸŸçš„é—®é¢˜ï¼Œè™½ç„¶åœ¨ä½ çš„é¡¹ç›®é‡Œï¼Œè„šæ‰‹æ¶å·²ç» 100%åšå¥½äº†æœ¬åœ°ä»£ç†ã€æˆ–è€…è¿ç»´è€é“åœ¨`nginx`ä¸­ä¹Ÿå·²ç»ç»™ä½ åšäº†æ¥å£ä»£ç†ï¼Œæ‰€ä»¥ä½ é‡åˆ°è·¨åŸŸçš„æ¦‚ç‡ä¼šå°‘äº†å¾ˆå¤šï¼Œä½†æ˜¯åœ¨ä¼ ç»Ÿçš„é¡¹ç›®ä¸­ï¼Œåœ¨é‚£ä¸ª`jquery`çš„æ¨ªè¡Œæ—¶ä»£ï¼Œæˆ–è€…ä½ æ¥æ‰‹äº†ä¸€ä¸ªç¥–ä¼ é¡¹ç›®æ—¶ï¼Œè·¨åŸŸé—®é¢˜ä¼šæ˜¯æ—¶æœ‰å‘ç”Ÿï¼Œæœ¬æ–‡åªåšç¬”è€…äº†è§£è·¨åŸŸçš„é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œå¸Œæœ›åœ¨å®é™…é¡¹ç›®ä¸­å¯¹ä½ æœ‰äº›æ€è€ƒå’Œå¸®åŠ©ã€‚

æ­£æ–‡å¼€å§‹...

### ä½•ä¸ºåŒæº

- åè®®ç›¸åŒ
- åŸŸåç›¸åŒ
- ç«¯å£ç›¸åŒ

éåŒæºæ˜¯æ— æ³•å½¼æ­¤è®¿é—®`cookie`,`domæ“ä½œ`ï¼Œ`ajax`ã€`localStorage`ã€`indexDB`æ“ä½œ

ä½†æ˜¯éåŒæºå¯ä»¥è®¿é—®ä»¥ä¸‹ä¸€äº›å±æ€§

```javascript
window.postMessage();
window.location
window.frames
window.parent
...
```

å¯¹äºéåŒæºç½‘ç«™è·¨åŸŸé€šä¿¡ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆ

### ç‰‡æ®µæ ‡è¯†ç¬¦

é€šè¿‡åœ¨`url`ä¸Šæ”¾å…¥`#type`ï¼Œåˆ©ç”¨`hashchange`äº‹ä»¶ï¼Œè·å–çˆ¶é¡µé¢çš„ç›¸å…³`hash`æ•°æ®

```javascript
// parent
const type = 'list';
const originUrl = originUrl + '#' + type;
const iframe = document.getElementById('iframe');
iframe.src = originUrl;
```

åœ¨å­`iframe`ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬`hashchange`äº‹ä»¶

```javascript
// iframe
window.addEventListener('hashchange', (evt) => {
  console.log(evt); // è·å–ç‰‡æ®µæ ‡è¯†ç¬¦çš„ç›¸å…³æ•°æ®
});
```

### è·¨æ–‡æ¡£é€šä¿¡ window.postMessage

å­é¡µé¢å¯ä»¥åˆ©ç”¨`window.postMessage`å‘çˆ¶é¡µé¢å‘é€ä¿¡æ¯ï¼Œçˆ¶é¡µé¢ç›‘å¬`message`æ¥æ”¶å­é¡µé¢å‘é€çš„æ¶ˆæ¯ï¼Œé€šå¸¸è¿™ç§æ–¹å¼åœ¨`iframe`é€šä¿¡ä¸­ç”¨å¾—åšå¤šï¼Œä¹Ÿæ˜¯è·¨åŸŸé€šä¿¡çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ

```javascript
// parent
window.addEventListener('message', (evt) => {
  const data = evt.data;
  console.log(data);
});
```

```javascript
// child
const origin = '*'; // è¿™é‡Œä¸€èˆ¬æ˜¯çˆ¶é¡µé¢çš„åŸŸåï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥æ˜¯*
const data = {
  text: 'hello, world'
};
window.postMessage(data, origin);
```

### jsonp

åˆ©ç”¨`script`æ ‡ç­¾ï¼Œå‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ª`get`è¯·æ±‚ï¼Œ`url`ä¸Šç»‘å®šä¸€ä¸ª`callback=fn`,è¿™ä¸ª`fn`é€šå¸¸æ˜¯ä¸åç«¯çº¦æŸå¥½ï¼Œ`fn`æ˜¯å®¢æˆ·ç«¯æ‰§è¡Œçš„å‡½æ•°åã€‚

ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è§£é‡Šä¸‹`jsonp`

å®¢æˆ·ç«¯ç¤ºä¾‹

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>jsonp</title>
  </head>
  <body>
    <h3>jsonp</h3>
    <div id="app"></div>
    <script>
      var script = document.createElement('script');
      script.setAttribute('type', 'text/javascript');
      script.src = 'http://192.168.31.40:8080/api?callback=jsonp';
      document.body.appendChild(script);
      const renderHtml = ({ name, age }, dom) => {
        dom.innerHTML = `<div>æˆ‘çš„åå­— ${name},ä»Šå¹´ ${age}å²äº†</div>`;
      };
      function jsonp(data) {
        console.log(data);
        const app = document.getElementById('app');
        const { name, age } = data;
        renderHtml({ name, age }, app);
      }
    </script>
  </body>
</html>
```

æœåŠ¡ç«¯ç¤ºä¾‹ä»£ç 

```js
// server.js
const http = require('http');
const fs = require('fs');
const path = require('path');
const PORT = '8080';
const server = http.createServer((req, res) => {
  res.statusCode = 200;
  // console.log(req.url);
  res.setHeader('Content-Type', 'text/html');
  fs.readFile(path.resolve(__dirname, '../', 'index.html'), (err, data) => {
    if (err) {
      res.end('404');
      return;
    }
    res.end(data);
  });
  const data = {
    name: 'Maic',
    age: Math.floor(Math.random() * 20)
  };
  if (req.url.includes('/api')) {
    res.end(`jsonp(${JSON.stringify(data)})`);
  }
});
server.listen(PORT, () => {
  console.log('server is start' + PORT);
});
```

æ³¨æ„æˆ‘ä»¬çœ‹åˆ°æœ‰è¿™æ ·çš„ä¸€æ®µåˆ¤æ–­`req.url.includes('/api')`,ç„¶åæˆ‘ä»¬`res.end(`jsonp(JSON.stringify(data))`)`,è¿”å›çš„å°±æ˜¯`jsonp`è¿™ä¸ªå›è°ƒå‡½æ•°ï¼ŒæŠŠæ•°æ®å½“å½¢å‚ä¼ ç»™å‰ç«¯ï¼Œåœ¨å®¢æˆ·ç«¯å®šä¹‰çš„`jsonp`æ–¹æ³•å°±èƒ½è·å–å¯¹åº”çš„æ•°æ®ã€‚

æ‰§è¡Œ`node server.js`æ‰“å¼€`http://localhost:8080`æˆ‘ä»¬ä¼šå‘ç°

![](https://files.mdnice.com/user/24614/24f7a796-d3d9-44e4-9b7e-a8b12ad596c6.png)
è¿”å›çš„æ•°æ®å°±æ˜¯`fn({name: 'xx',age: 'xx'})`

æˆ‘ä»¬çœ‹ä¸‹è¯·æ±‚å¤´
![](https://files.mdnice.com/user/24614/a5a33dde-c0d6-4942-84e2-6eae43aae25e.png)
æµè§ˆå™¨ä¼šå‘é€ä¸€ä¸ª`get`è¯·æ±‚ï¼Œæ‰€æºå¸¦çš„å‚æ•°å°±æ˜¯`callback: jsonp`,è€Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ç¡®å®æ˜¯é€šè¿‡`jsonp`è¿™ä¸ªæ–¹æ³•æ‹¿åˆ°å¯¹åº”çš„æ•°æ®äº†ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŸ¥é“`jsonp`å®é™…ä¸Šå°±æ˜¯åˆ©ç”¨ä¸€ä¸ªå®¢æˆ·ç«¯å‘é€çš„`get`è¯·æ±‚æºå¸¦ä¸€ä¸ªåç«¯æœåŠ¡çš„è¿”å›çš„`å›è°ƒå‡½æ•°`,åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å®šä¹‰è¿™ä¸ª`å›è°ƒå‡½æ•°`å°±å¯ä»¥è·å–åç«¯è¿”å›çš„å½¢å‚æ•°æ®äº†ã€‚

ä»`jsonp`è¿™ç§è·¨åŸŸé€šä¿¡æ¥çœ‹ï¼Œå…¶å®æœ‰ä¹Ÿå®ƒçš„ç¼ºç‚¹å’Œä¼˜ç‚¹

- ç¼ºç‚¹

1ã€å®ƒçš„å®‰å…¨æ€§ä¼šæœ‰ä¸€å®šé£é™©ï¼Œå› ä¸ºä¾èµ–çš„ç»“æœå°±æ˜¯é‚£ä¸ªå›è°ƒå‡½æ•°çš„å½¢å‚å†…å®¹ï¼Œå¦‚æœè¢«äººåŠ«æŒä¿®æ”¹è¿”å›æ•°æ®ï¼Œé‚£å¯èƒ½ä¼šé€ æˆå®‰å…¨æ€§é—®é¢˜

2ã€ä»…æ”¯æŒ`get`è¯·æ±‚ï¼Œä¸æ”¯æŒå…¶å®ƒ`http`è¯·æ±‚æ–¹å¼ï¼Œæˆ‘ä»¬å‘ç°`jsonp`è¿™ç§é€šä¿¡å°±æ˜¯åˆ©ç”¨`script`æ ‡ç­¾è¯·æ±‚äº†ä¸€ä¸ª`url`,`url`ä¸Šæºå¸¦äº†ä¸€ä¸ªå¯æ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼Œè¿›è€Œé€šè¿‡åç«¯ç»™å›è°ƒå‡½æ•°ä¼ é€’æ•°æ®çš„ã€‚

3ã€æ²¡æœ‰ä»»ä½•çŠ¶æ€ç ï¼Œæ•°æ®ä¸¢ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœæœ‰å¤±è´¥æƒ…å†µï¼Œä¸ä¼šæœ‰åƒ`http`çŠ¶æ€ç ä¸€æ ·

- ä¼˜ç‚¹

èƒ½è§£å†³è·¨åŸŸé€šä¿¡é—®é¢˜ï¼Œå…¼å®¹æ€§æ¯”è¾ƒå¥½ï¼Œä¸å—åŒæºç­–ç•¥çš„å½±å“ï¼Œå¯¹åç«¯æ¥è¯´å®ç°ä¹Ÿç®€å•ã€‚

åœ¨ä»¥å‰æ¯”è¾ƒä¹…è¿œçš„é¡¹ç›®ä¸­ï¼Œä½ å¯èƒ½æ˜¯ç›´æ¥ä½¿ç”¨`jquery`ï¼Œ`jsonp`å°±`ok`äº†,å¤§æ¦‚çš„ä»£ç å°±æ˜¯é•¿è¿™æ ·çš„

```js
$.ajax({
  url: 'xxx',
  dataType: 'jsonp',
  jsonp: 'successCallback',
  success: (data) => {
    console.log(data);
  },
  error: (err) => {
    console.log(err);
  }
});
```

`successCallback`è¿™ä¸ªå°±æ˜¯ä¸æœåŠ¡ç«¯çº¦æŸçš„å›è°ƒå‡½æ•°ï¼Œä¸€èˆ¬ä¸æœåŠ¡ç«¯æ²Ÿé€šä¸€è‡´å°±è¡Œï¼Œé‚£ä¹ˆç®€å•çš„`jsonp`å°±å·²ç»å®Œæˆäº†,æ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆç®€å•å‘¢ï¼Ÿ

### WebSocket

ç”±äº`WebSocket`ä¸å—åŒæºç­–ç•¥çš„é™åˆ¶ï¼Œå› æ­¤`WebSocket`ä¹Ÿæ˜¯å¯ä»¥å®ç°è·¨åŸŸé€šä¿¡çš„ã€‚è¿™é‡Œå°±ä¸ä¸¾ä¾‹å­äº†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒä¹‹å‰å†™çš„ä¸€ç¯‡[æµ…è°ˆ websocket](https://mp.weixin.qq.com/s?__biz=Mzk0ODMxODIzNw==&mid=2247487539&idx=1&sn=7336057d6c0675846229c07497acf840&chksm=c3682941f41fa057e984ac8eb034b5d9c0bb1c75c79b5f895952fc535c25eb92f08a36e74bab&=897076076&=zh_CN#rd)è¿™ç¯‡æ–‡ç« 

### CORS è·¨åŸŸèµ„æºåˆ†äº«

è¿™ç§æ–¹å¼æ˜¯åœ¨æœåŠ¡ç«¯è¿›è¡Œæ§åˆ¶ï¼Œå…è®¸ä»»ä½•èµ„æºè¯·æ±‚ã€‚å…¶å®åœ¨æµè§ˆå™¨ç«¯ï¼Œå³ä½¿è·¨åŸŸï¼Œè¿˜æ˜¯ä¼šæ­£å¸¸è¯·æ±‚ï¼Œåªæ˜¯è¯·æ±‚éåŒæºç¯å¢ƒçš„åç«¯æœåŠ¡ï¼Œæµè§ˆå™¨ç¦æ­¢è¯·æ±‚è®¿é—®,æ›´å¤šå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« [cors](https://www.wangdoc.com/javascript/bom/cors.html 'cors')

æˆ‘ä»¬å†™ä¸ªä¾‹å­å…·ä½“æµ‹è¯•ä¸€ä¸‹,åœ¨å®¢æˆ·ç«¯åŠ å…¥è¿™æ®µä»£ç 

```js
const send = document.getElementById('send');
send.onclick = function () {
  if (!window.fetch) {
    return;
  }
  fetch('http://localhost:8081/list.json')
    .then((res) => res.json())
    .then((result) => {
      console.log(result);
      const contentDom = document.querySelector('.content');
      renderHtml(result, contentDom);
    });
};
```

æœåŠ¡ç«¯ä»£ç ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª`index2.js`æœåŠ¡ç«¯ä»£ç ,å¹¶æ‰§è¡Œ`node index2.js`

```js
const http = require('http');
const PORT = '8081';
const server = http.createServer((req, res) => {
  res.statusCode = 200;
  // // console.log(req.url);
  res.setHeader('Content-Type', 'application/json');
  if (req.url.includes('/list.json')) {
    res.end(
      JSON.stringify({
        name: 'maic',
        age: Math.ceil(Math.random() * 20)
      })
    );
  }
});
server.listen(PORT, () => {
  console.log('server is start' + PORT);
});
```

æˆ‘ä»¬æ³¨æ„åˆ°è¯·æ±‚çš„ç«¯å£æ˜¯`8081`,æ‰“å¼€`8080`é¡µé¢

![](https://files.mdnice.com/user/24614/5aed984e-7a20-48d7-9c14-b4f3e80556ba.png)
ç‚¹å‡»æŒ‰é’®ï¼Œå‘é€`fetch`è¯·æ±‚ï¼Œæˆ‘ä»¬å‘ç°æµè§ˆå™¨æŠ¥äº†è¿™æ ·ä½ å¸¸å¸¸çœ‹åˆ°çš„è·¨åŸŸä¿¡æ¯`as been blocked by CORS policy: No 'Access-Control-Allow-Origin' header...`,å› ä¸ºè·¨åŸŸäº†

ç´§æ¥ç€æˆ‘ä»¬åœ¨æœåŠ¡ç«¯è®¾ç½®ä¸‹`Access-Control-Allow-Origin: *`

```js
const http = require('http');
const PORT = '8081';
const server = http.createServer((req, res) => {
  res.statusCode = 200;
  // // console.log(req.url);
  res.setHeader('Content-Type', 'application/json');
  res.setHeader('Access-Control-Allow-Origin', '*');
  if (req.url.includes('/list.json')) {
    res.end(
      JSON.stringify({
        name: 'maic',
        age: Math.ceil(Math.random() * 20)
      })
    );
  }
});
server.listen(PORT, () => {
  console.log('server is start' + PORT);
});
```

æ­¤æ—¶å†æ¬¡è®¿é—®æ—¶ï¼Œå·²ç» ok äº†
![](https://files.mdnice.com/user/24614/f712a4e4-7182-48f9-9772-44ff847eee9c.png)
![](https://files.mdnice.com/user/24614/995393eb-0b34-4a7f-bd71-bbeff0c41c57.png)
æ³¨æ„æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹`Response Headers`

```js
HTTP/1.1 200 OK
Content-Type: application/json
Access-Control-Allow-Origin: *
Date: Sun, 01 May 2022 14:23:59 GMT
Connection: keep-alive
Content-Length: 24
```

`Access-Control-Allow-Origin:*`è¿™æ˜¯æˆ‘ä»¬æœåŠ¡çš„è®¾ç½®å“åº”è¯·æ±‚å¤´ï¼Œè®¾ç½®å…è®¸æ‰€æœ‰åŸŸåè¯·æ±‚ã€‚

å› æ­¤`cors`è·¨åŸŸå…¶å®åœ¨æœåŠ¡ç«¯è®¾ç½®`Access-Control-Allow-Originï¼š *`ä¹Ÿå°±å®Œç¾çš„è§£å†³äº†è·¨åŸŸé—®é¢˜ã€‚

### æ€»ç»“

- è·¨åŸŸäº§ç”Ÿçš„åŸå› ï¼Œä¸»è¦å—åŒæºç­–ç•¥çš„å½±å“ï¼ŒéåŒæºç¯å¢ƒï¼Œæ— æ³•ç›¸äº’è®¿é—®`cookie`ã€`localStorage`ã€`domæ“ä½œ`ç­‰

- è§£å†³è·¨åŸŸçš„æ–¹æ¡ˆä¸»è¦æœ‰`ç‰‡æ®µæ ‡è¯†ç¬¦`ã€`iframeé€šä¿¡postMessage`,`jsonp`ã€`WebSocket`ã€`cors`

- ç”¨å…·ä½“å®é™…ä¾‹å­æ·±å…¥äº†è§£å‡ ç§è·¨åŸŸæ¨¡å¼ï¼Œæ¯”å¦‚`jsonp`,å®é™…ä¸Šæ˜¯åˆ©ç”¨`script`å‘é€ä¸€ä¸ª`get`è¯·æ±‚ï¼Œåœ¨`get`è¯·æ±‚çš„å‚æ•°ä¸­ä¼ å…¥ä¸€ä¸ªå¯æ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼ŒæœåŠ¡æ ¹æ®è¯·æ±‚ï¼Œå°†è¿”å›ä¸€ä¸ªå‰ç«¯å¯æ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”å°†æ•°æ®å½“æˆè¯¥å›è°ƒå‡½æ•°çš„å½¢å‚ï¼Œåœ¨å‰ç«¯å®šä¹‰è¯¥å›è°ƒå‡½æ•°ï¼Œä»è€Œè·å–è°ƒå‡½æ•°ä¼ å…¥çš„æ•°æ®ã€‚

- ç”¨å…·ä½“ ğŸŒ° çœ‹åˆ°æœåŠ¡ç«¯è®¾ç½®`cors`,ä¸»è¦æ˜¯åœ¨åç«¯æ¥å£è¿”å›å“åº”å¤´é‡Œè®¾ç½®`Access-Control-Allow-Origin:*`å…è®¸æ‰€æœ‰ä¸åŒæºç½‘ç«™è®¿é—®ï¼Œè¿™ç§æ–¹æ³•ä¹Ÿæ˜¯æ¯”è¾ƒç²—æš´çš„è§£å†³è·¨åŸŸé—®é¢˜ã€‚

- æœ¬æ–‡ç¤ºä¾‹ä»£ç [code example](https://github.com/maicFir/lessonNote/tree/master/node/jsonp 'code example')
